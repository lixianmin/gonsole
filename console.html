<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <title>Console</title>
    <script type="application/javascript" src="sha256.min.js"></script>
    <script type="text/javascript">
        Date.prototype.Format = function (fmt) {
            let o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (let k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };

        window.onload = function () {
            let conn;
            const mainPanel = document.getElementById("mainPanel");
            const inputBox = document.getElementById("inputBox");

            let currentReceivedSize = 0;
            let totalReceivedSize = 0;

            let history = Array();
            let historyIndex = -1;

            let username = "";
            let isAuthorizing = false;

            const handlers = [];
            const myHost = window.location.host + {{.UrlRoot}};

            // 将history存储到localStorage中
            if (window.localStorage) {
                const key = "history";

                const json = localStorage.getItem(key);
                const jsonObj = JSON.parse(json);
                if (jsonObj) {
                    history = jsonObj;
                    historyIndex = history.length - 1;
                }

                window.onunload = function () {
                    localStorage.setItem(key, JSON.stringify(history.slice(-100)));
                };
            }

            function addHistory(command) {
                historyIndex = history.push(command);
            }

            function appendLog(item) {
                let doScroll = mainPanel.scrollTop > mainPanel.scrollHeight - mainPanel.clientHeight - 1;
                mainPanel.appendChild(item);
                if (doScroll) {
                    mainPanel.scrollTop = mainPanel.scrollHeight - mainPanel.clientHeight;
                }
            }

            function printHtml(html) {
                const item = document.createElement("div");
                item.innerHTML = html;
                appendLog(item);
            }

            function printText(text) {
                const item = document.createElement("div");
                item.innerText = text;
                appendLog(item)
            }

            function println() {
                printHtml("<br/>");
            }

            function printWithTimestamp(html) {
                const current = getHumanReadableSize(currentReceivedSize);
                const total = getHumanReadableSize(totalReceivedSize);
                printHtml("[" + (new Date()).Format("hh:mm:ss.S") + " (" + current + "/" + total + ") ] " + html);
            }

            function sendBean(bean) {
                const data = JSON.stringify(bean);
                printWithTimestamp("<b>client请求：</b>");
                printHtml(data);
                println();
                conn.send(data);
            }

            function getLinkHtml(name, url) {
                return "<div><a href=\"" + url + "\">" + name + "</a></div>";
            }

            function getHumanReadableSize(size) {
                if (size < 1024) {
                    return size + "B";
                }

                if (size < 1048576) {
                    return (size / 1024.0).toFixed(1) + "K";
                }

                return (size / 1048576.0).toFixed(1) + "M";
            }

            document.onkeydown = function (evt) {
                if (!conn) {
                    return true;
                }

                // 回车
                if (evt.key === 'Enter') {
                    let control = document.activeElement;
                    if (control !== inputBox) {
                        inputBox.focus();
                        // return false的意思是：这个按键事件本js处理了，不再传播这个事件。
                        // 默认情况下会继续传播按键事件，Enter会导致页面refresh
                        return false;
                    }
                }
            };

            inputBox.onkeydown = function (evt) {
                if (!conn) {
                    return true;
                }

                // 回车
                if (evt.key === 'Enter') {
                    let command = inputBox.value.trim();
                    if (command !== "") {
                        inputBox.value = "";

                        // 检查是不是调用history命令
                        if (command.startsWith("!")) {
                            const index = parseInt(command.substr(1)) - 1;
                            if (!isNaN(index) && index >= 0 && index < history.length) {
                                command = history[index];
                            }
                        }

                        let texts = command.split(/\s+/);  // 支持连续多个空格
                        let textsLength = texts.length;

                        if (textsLength >= 2 && (texts[0] === "sub" || texts[0] === "unsub")) {
                            const bean = {
                                op: texts[0],
                                rid: "request-id",
                                topic: texts[1],
                            };

                            sendBean(bean);
                            addHistory(command);
                        } else if (textsLength >= 2 && texts[0] === "auth") {
                            username = texts[1];
                            isAuthorizing = true;
                            inputBox.type = "password";
                            printWithTimestamp(command + "<br/> <h3>请输入密码：</h3><br/>");
                            addHistory(command);
                        } else if (isAuthorizing && textsLength >= 1) {
                            isAuthorizing = false;
                            inputBox.type = "text";

                            const password = texts[0];
                            const key = "hey pet!";
                            const digest = sha256.hmac(key, password);

                            const bean = {
                                op: "command",
                                command: "auth " + username + " " + digest,
                            };

                            sendBean(bean);
                        } else {
                            const bean = {
                                op: "command",
                                command: command,
                            };

                            sendBean(bean);
                            addHistory(command);
                        }
                    }

                    return false;
                } else if (evt.key === 'ArrowUp' || evt.key === 'ArrowDown') {
                    const isArrowUp = evt.key === 'ArrowUp';
                    let isChanged = false;
                    if (isArrowUp && historyIndex > 0) {
                        historyIndex -= 1;
                        isChanged = true;
                    } else if (!isArrowUp && historyIndex + 1 < history.length) {
                        historyIndex += 1;
                        isChanged = true;
                    }

                    if (isChanged) {
                        inputBox.value = history[historyIndex];
                        setTimeout(function () {
                                let position = inputBox.value.length;
                                inputBox.setSelectionRange(position, position);
                                inputBox.focus();
                            }
                            , 0);
                    }

                    return false;
                } else if (evt.key === 'Tab') {
                    const bean = {
                        op: "hint",
                        head: inputBox.value.trim(),
                    };

                    const data = JSON.stringify(bean);
                    conn.send(data);
                    return false;
                } else {
                    // printText(evt.key);
                }

                return true;
            };

            handlers["help"] = function (obj) {
                const commands = obj.commands;
                let result = "<br/><b>命令列表：</b> <br> <table><tr><th>Command</th><th>Note</th></tr>";
                for (let i = 0; i < commands.length; i++) {
                    result += "<tr><td>" + commands[i][0] + "</td><td>" + commands[i][1] + "</td>";
                }
                result += "</table>";

                const topics = obj.topics;
                result += "<br/><b>主题列表：</b> <br> <table><tr><th>Topic</th><th>Note</th></tr>";
                for (let i = 0; i < topics.length; i++) {
                    result += "<tr><td>" + topics[i][0] + "</td><td>" + topics[i][1] + "</td>";
                }
                result += "</table>";
                result += "<br/>";

                const host = document.location.protocol + "//" + myHost;
                result += getLinkHtml("pprof", host + "/debug/pprof");
                result += getLinkHtml("文档参考", "https://github.com/lixianmin/writer/blob/master/golang/pprof.md");

                result += "<div>";
                const tail = "<br>";
                result += "go tool pprof " + host + "/debug/pprof/profile" + tail; // 30-second CPU profile
                result += "go tool pprof " + host + "/debug/pprof/heap" + tail;    // heap profile
                result += "curl -G -k " + host + "/debug/pprof/goroutine?debug=2 > tmp.prof" + tail;
                result += "</div>";

                printWithTimestamp(result)
            };

            handlers["listLogFiles"] = function (obj) {
                const host = document.location.protocol + "//" + myHost;
                const logFiles = obj.logFiles;
                const fileCount = logFiles.length;
                const links = new Array(fileCount);
                let totalSize = 0;
                for (let i = 0; i < fileCount; i++) {
                    const fi = logFiles[i];
                    totalSize += fi.size;
                    let sizeText = getHumanReadableSize(fi.size);
                    links[i] = "<tr><td>" + sizeText + "</td><td><a href=\"" + host + "/" + fi.path + "\">" + fi.path + "</a></li></td>";
                }

                let result = "<b>日志文件列表：</b> <br> count:&nbsp;" + fileCount + "<br>total:&nbsp;&nbsp;" + getHumanReadableSize(totalSize) + "<br>";
                result += "<table> <tr><th>Size</th><th>Name</th></tr>" + links.join("") + "</table>";
                printWithTimestamp(result);
            };

            handlers["listHistoryCommands"] = function (obj) {
                const count = history.length;
                const items = new Array(count);
                for (let i = 0; i < count; i++) {
                    items[i] = "<li>" + history[i] + "</li>";
                }

                let result = "<b>历史命令列表：</b> <br/> count:&nbsp;" + count + "<br/><ol>" + items.join("") + "</ol>";
                printWithTimestamp(result);
            };

            handlers['hintResponse'] = function (obj) {
                const hints = obj.hints;
                const count = hints.length;

                if (count === 1) {
                    inputBox.value = hints[0];
                } else {
                    const items = new Array(count);
                    for (let i = 0; i < count; i++) {
                        items[i] = "<li>" + hints[i] + "</li>";
                    }

                    const result = "<b>参考命令列表：</b> <br/> count:&nbsp;" + count + "<br/><ol>" + items.join("") + "</ol>";
                    printWithTimestamp(result);
                }
            };

            if (window["WebSocket"]) {
                const isHttps = "https:" === document.location.protocol;
                const protocol = isHttps ? "wss://" : "ws://";
                const url = protocol + myHost + "/" + {{.WebsocketName}};

                conn = new WebSocket(url);
                conn.onclose = function (evt) {
                    printHtml("<b>Connection closed.</b>");
                };

                conn.onmessage = function (evt) {
                    const data = evt.data;
                    currentReceivedSize = data.length;
                    totalReceivedSize += currentReceivedSize;
                    const messages = data.split('\n');
                    for (let i = 0; i < messages.length; i++) {
                        const message = messages[i];
                        if (message === "") {
                            continue
                        }
                        const obj = JSON.parse(message);
                        const handler = handlers[obj.op];
                        if (null != handler) {
                            handler(obj);
                        } else {
                            printWithTimestamp("<b>server返回：</b>" + message);
                        }
                        println();
                    }
                };
            } else {
                printHtml("<b>Your browser does not support WebSockets.</b>");
            }

            inputBox.focus();
            printHtml("Input 'help' and press Enter to fetch builtin commands.");
            println();
        };
    </script>
    <style type="text/css">
        /*http://thomasf.github.io/solarized-css/*/
        html {background-color: #002b36;color: #839496;margin: 1em;font-size: 1.2em;}

        a {color: #b58900;}
        a:visited {color: #cb4b16;}
        a:hover {color: #cb4b16;}

        table { border-width: 1px; border-color: #729ea5;border-collapse: collapse;}
        th { background-color:#004949; border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;text-align:left;}
        td { border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;}

        #mainPanel {margin: 0;padding: 0.5em 0.5em 0.5em 0.5em;position: absolute;top: 0.5em;left: 0.5em;right: 0.5em;bottom: 3em;overflow: auto;}
        #form {padding: 0 0.5em 0 0.5em;margin: 0;position: absolute;bottom: 1em;left: 1px;width: 100%;overflow: hidden;}
        #inputBox {width:100%;height:1.6em;font-size:1.5em; background-color: #073642; color: #859900}

    </style>
</head>
<body>
<div id="mainPanel"></div>
<form id="form">
    <input id="inputBox" type="text" value=""/>
</form>
</body>
</html>