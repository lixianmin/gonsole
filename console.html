<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <title>{{.Title}}</title>
    <script type="text/javascript" src="sha256.min.js"></script>
    <script type="text/javascript">
        Date.prototype.Format = function (fmt) {
            let o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (let k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };

        function copyToClipboard(text) {
            let box = document.getElementById("inputBox");
            const lastValue = box.value;
            box.value = text;
            box.select();
            document.execCommand("Copy");
            box.value = lastValue;
        }

        window.onload = function () {
            let conn;
            const mainPanel = document.getElementById("mainPanel");
            const inputBox = document.getElementById("inputBox");

            let currentReceivedSize = 0;
            let totalReceivedSize = 0;

            let history = Array();
            let historyIndex = -1;

            let username = "";
            let isAuthorizing = false;

            const handlers = [];
            const myHost = window.location.host + {{.UrlRoot}};

            // 将history存储到localStorage中
            if (localStorage) {
                const key = "history";
                const json = localStorage.getItem(key);
                const jsonObj = JSON.parse(json);
                if (jsonObj) {
                    history = jsonObj;
                    historyIndex = history.length - 1;
                }

                window.onunload = function () {
                    localStorage.setItem(key, JSON.stringify(history.slice(-100)));
                };
            }

            function addHistory(command) {
                historyIndex = history.push(command);
            }

            function appendLog(item) {
                let doScroll = mainPanel.scrollTop > mainPanel.scrollHeight - mainPanel.clientHeight - 1;
                mainPanel.appendChild(item);
                if (doScroll) {
                    mainPanel.scrollTop = mainPanel.scrollHeight - mainPanel.clientHeight;
                }
            }

            function printHtml(html) {
                const item = document.createElement("div");
                item.innerHTML = html;
                appendLog(item);
            }

            function printText(text) {
                const item = document.createElement("div");
                item.innerText = text;
                appendLog(item)
            }

            function println() {
                printHtml("<br/>");
            }

            function printWithTimestamp(html) {
                const current = getHumanReadableSize(currentReceivedSize);
                const total = getHumanReadableSize(totalReceivedSize);
                printHtml("[" + (new Date()).Format("hh:mm:ss.S") + " (" + current + "/" + total + ") ] " + html);
            }

            function sendBean(bean) {
                const data = JSON.stringify(bean);
                printWithTimestamp("<b>client请求：</b>");
                printHtml(data);
                println();
                conn.send(data);
            }

            function getHumanReadableSize(size) {
                if (size < 1024) {
                    return size + "B";
                }

                if (size < 1048576) {
                    return (size / 1024.0).toFixed(1) + "K";
                }

                return (size / 1048576.0).toFixed(1) + "M";
            }

            function longestCommonPrefix(strs) {
                if (strs.length < 2) return strs.join();
                let str = strs[0];
                for (let i = 1; i < strs.length; i++) {
                    for (let j = str.length; j > 0; j--) {
                        if (str !== strs[i].substr(0, j)) str = str.substr(0, j - 1);
                        else break
                    }
                }
                return str
            }

            function login(username, password) {
                const key = "hey pet!";
                const digest = sha256.hmac(key, password);

                const bean = {
                    op: "command",
                    command: "auth " + username + " " + digest,
                };

                sendBean(bean);
            }

            document.onkeydown = function (evt) {
                if (!conn) {
                    return true;
                }

                // 回车
                if (evt.key === 'Enter') {
                    let control = document.activeElement;
                    if (control !== inputBox) {
                        inputBox.focus();
                        // return false的意思是：这个按键事件本js处理了，不再传播这个事件。
                        // 默认情况下会继续传播按键事件，Enter会导致页面refresh
                        return false;
                    }
                }
            };

            inputBox.onkeydown = function (evt) {
                if (!conn) {
                    return true;
                }

                // 回车
                if (evt.key === 'Enter') {
                    let command = inputBox.value.trim();
                    if (command !== "") {
                        inputBox.value = "";

                        // 检查是不是调用history命令
                        if (command.startsWith("!")) {
                            const index = parseInt(command.substr(1)) - 1;
                            if (!isNaN(index) && index >= 0 && index < history.length) {
                                command = history[index];
                            }
                        }

                        let texts = command.split(/\s+/);  // 支持连续多个空格
                        let textsLength = texts.length;
                        const name = texts[0];

                        if (name === 'help') {
                            const host = document.location.protocol + "//" + myHost;
                            const bean = {
                                op: "command",
                                command: name + " " + host,
                            };

                            sendBean(bean);
                            addHistory(command);
                        } else if (textsLength >= 2 && (name === "sub" || name === "unsub")) {
                            const bean = {
                                op: name,
                                rid: "request-id",
                                topic: texts[1],
                            };

                            sendBean(bean);
                            addHistory(command);
                        } else if (textsLength >= 2 && name === "auth") {
                            username = texts[1];
                            isAuthorizing = true;
                            inputBox.type = "password";
                            printWithTimestamp(command + "<br/> <h3>请输入密码：</h3><br/>");
                            addHistory(command);
                        } else if (isAuthorizing && textsLength >= 1) {
                            isAuthorizing = false;
                            inputBox.type = "text";

                            const password = name;
                            login(username, password);

                            if (localStorage) {
                                const key = "autoLoginUser";
                                const item = {
                                    username: username,
                                    password: password,
                                    expireTime: new Date().getTime() + {{.AutoLoginLimit}},
                                };

                                const data = JSON.stringify(item);
                                localStorage.setItem(key, data);
                            }
                        } else {
                            const bean = {
                                op: "command",
                                command: texts.join(' '),
                            };

                            sendBean(bean);
                            addHistory(command);
                        }
                    } else {
                        printWithTimestamp('');
                    }

                    return false;
                } else if (evt.key === 'ArrowUp' || evt.key === 'ArrowDown') {
                    const isArrowUp = evt.key === 'ArrowUp';
                    let isChanged = false;
                    if (isArrowUp && historyIndex > 0) {
                        historyIndex -= 1;
                        isChanged = true;
                    } else if (!isArrowUp && historyIndex + 1 < history.length) {
                        historyIndex += 1;
                        isChanged = true;
                    }

                    if (isChanged) {
                        inputBox.value = history[historyIndex];
                        setTimeout(function () {
                                let position = inputBox.value.length;
                                inputBox.setSelectionRange(position, position);
                                inputBox.focus();
                            }
                            , 0);
                    }

                    return false;
                } else if (evt.key === 'Tab') {
                    const text = inputBox.value.trim();
                    if (text.length > 0) {
                        const bean = {
                            op: "hint",
                            head: text,
                        };

                        const data = JSON.stringify(bean);
                        conn.send(data);
                    }

                    return false;
                } else {
                    // printText(evt.key);
                }

                return true;
            };

            handlers['challenge'] = function (obj) {
                printWithTimestamp("<b>server响应：</b>" + JSON.stringify(obj));
                println();

                // 测试是否可以自动登录
                if (localStorage) {
                    const key = "autoLoginUser";
                    const json = localStorage.getItem(key);
                    const jsonObj = JSON.parse(json);
                    if (jsonObj && new Date().getTime() < jsonObj.expireTime) {
                        login(jsonObj.username, jsonObj.password);
                    }
                }
            };

            handlers["log.list"] = function (obj) {
                const host = document.location.protocol + "//" + myHost;
                const logFiles = obj.logFiles;
                const fileCount = logFiles.length;
                const links = new Array(fileCount);
                let totalSize = 0;
                for (let i = 0; i < fileCount; i++) {
                    const fi = logFiles[i];
                    totalSize += fi.size;
                    let sizeText = getHumanReadableSize(fi.size);
                    links[i] = `<tr> <td>${i + 1}</td> <td>${sizeText}</td> <td> <div class="tips"><a href="${host}/${fi.path}">${fi.path}</a> <span class="tips_text">${fi.sample}</span>
                                <input type="button" class="copy_button" onclick="copyToClipboard('${fi.path}')" value="复制"/>
                                </div></td> <td>${fi.mod_time}</td> </tr>`;
                }

                let result = "<b>日志文件列表：</b> <br> count:&nbsp;" + fileCount + "<br>total:&nbsp;&nbsp;" + getHumanReadableSize(totalSize) + "<br>";
                result += "<table> <tr> <th></th> <th>Size</th> <th>Name</th> <th>Modified Time</th> </tr>" + links.join("") + "</table>";
                printWithTimestamp(result);
                println();
            };

            handlers["history"] = function (obj) {
                const count = history.length;
                const items = new Array(count);
                for (let i = 0; i < count; i++) {
                    items[i] = "<li>" + history[i] + "</li>";
                }

                let result = "<b>历史命令列表：</b> <br/> count:&nbsp;" + count + "<br/><ol>" + items.join("") + "</ol>";
                printWithTimestamp(result);
                println();
            };

            handlers['hintResponse'] = function (obj) {
                const hints = obj.hints;
                const count = hints.length;
                if (count > 0) {
                    inputBox.value = longestCommonPrefix(hints);
                    if (count > 1) {
                        const items = new Array(count);
                        for (let i = 0; i < count; i++) {
                            items[i] = "<li>" + hints[i] + "</li>";
                        }

                        const result = "<b>参考命令列表：</b> <br/> count:&nbsp;" + count + "<br/><ol>" + items.join("") + "</ol>";
                        printWithTimestamp(result);
                        println();
                    }
                }
            };

            handlers['html'] = function (obj) {
                printWithTimestamp("<b>server响应：</b>" + obj.html);
                println();
            };

            // ping/pong保活
            setInterval(function () {conn.send("{\"op\":\"ping\"}");}, 2000);
            handlers['pong'] = function (obj) {};

            if (window["WebSocket"]) {
                const isHttps = "https:" === document.location.protocol;
                const protocol = isHttps ? "wss://" : "ws://";
                const url = protocol + myHost + "/" + {{.WebsocketName}};

                conn = new WebSocket(url);
                conn.onclose = function (evt) {
                    printHtml("<b>Connection closed.</b>");
                };

                conn.onmessage = function (evt) {
                    const data = evt.data;
                    currentReceivedSize = data.length;
                    totalReceivedSize += currentReceivedSize;
                    const messages = data.split('\n');
                    for (let i = 0; i < messages.length; i++) {
                        const message = messages[i];
                        if (message === "") {
                            continue
                        }
                        const obj = JSON.parse(message);
                        const handler = handlers[obj.op];
                        if (null != handler) {
                            handler(obj);
                        } else {
                            printWithTimestamp("<b>server响应：</b>" + message);
                            println();
                        }
                    }
                };
            } else {
                printHtml("<b>Your browser does not support WebSockets.</b>");
            }

            inputBox.focus();
            printHtml("Input 'help' and press 'Enter' to fetch builtin commands. <a href=\"https://github.com/lixianmin/gonsole\">learn more</a>");
            println();
        };
    </script>
    <style type="text/css">
        /*http://thomasf.github.io/solarized-css/*/
        html {background-color: #002b36;color: #839496;margin: 1em;font-size: 1.2em;}
        .copy_button { background-color: #008CBA; border: none; color: white; }

        a {color: #b58900;}
        a:visited {color: #cb4b16;}
        a:hover {color: #cb4b16;}

        table { border-width: 1px; border-color: #729ea5;border-collapse: collapse;}
        th { background-color:#004949; border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;text-align:left;}
        td { border-width: 1px;padding: 8px;border-style: solid;border-color: #729ea5;}

        /*https://www.runoob.com/css/css-tooltip.html*/
        .tips { position: relative; display: inline-block; border-bottom: 1px dotted black; }

        .tips .tips_text {
            visibility: hidden; display: inline-block; white-space: nowrap; background: #005959; border-radius: 6px; padding: 6px 6px;
            /* 定位 */
            position: absolute; z-index: 1; top: -5px;left: 105%;
        }

        .tips:hover .tips_text { visibility: visible; }

        #mainPanel {margin: 0;padding: 0.5em 0.5em 0.5em 0.5em;position: absolute;top: 0.5em;left: 0.5em;right: 0.5em;bottom: 3em;overflow: auto;}
        #form {padding: 0 0.5em 0 0.5em;margin: 0;position: absolute;bottom: 1em;left: 1px;width: 100%;overflow: hidden;}
        #inputBox {width:100%;height:1.6em;font-size:1.5em; background-color: #073642; color: #859900}

    </style>
</head>
<body>
<div id="mainPanel"></div>
<form id="form">
    <input id="inputBox" type="text" value=""/>
</form>
</body>
</html>